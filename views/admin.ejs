<!DOCTYPE html>
<html>

<head>
    <title>Admin</title>
    <style>
    </style>
</head>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<body class="d-flex flex-column min-vh-100">
    <%- include('navbar2.ejs') %>
        <br>
        <h1 class="text-center">Manage Users</h1>
        <br>


        <section class="d-flex">
            <div class="col-9 flex-grow-1 d-flex flex-column ">
                <div class="container mt-5 p-3">
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table align-middle text-center">
                                <thread>
                                    <tr>
                                        <td><button class="btn btn btn-danger" id="promoteToModerator">Promote to
                                                Moderator</button></td>
                                        <td><button class="btn btn-danger" id="promoteToAdmin">Promote to
                                                Admin</button></td>
                                        <td><button class="btn btn-danger" id="deleteUsers">Delete
                                                User</button></td>
                                    </tr>
                                </thread>
                            </table>
                            <table class="table table-bordered align-middle text-center">

                                <thread id="usersTable">
                                    <tr>
                                        <td>User Name</td>
                                        <td>Last Login Time</td>
                                        <td>Posts</td>
                                        <td>Type</td>
                                    </tr>
                                </thread>

                                <script>
                                    async function getAllUsers() {
                                        const api_url = '/api/getAllUsers'
                                        const response = await fetch(api_url);
                                        const data = await response.json();
                                        const list = document.getElementById("usersTable");
                                        let userRowBody = "";
                                        data.forEach((item) => {
                                            userRowBody = userRowBody + `<tr> 
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="${item.username}" name="username" value="${item.username}"/>
                                            <label class="form-check-label" for="${item.username}"> ${item.username}</label>
                                        </div>
                                    </td>
                                    <td>${item.lastLogin}</td>
                                    <td>${item.post}</td>
                                    <td>${item.type}</td>
                                    </tr> `;
                                        });

                                        document.getElementById("myUsers").innerHTML = userRowBody;
                                    }
                                    getAllUsers();
                                </script>
                                <tbody class="align-middle text-center" id="myUsers">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



            </div>
            </div>

        </section>
        <%- include('footer.ejs') %>
            <script> $('#select-all').click(function (event) {
                    if (this.checked) {
                        // Iterate each checkbox
                        $(':checkbox').each(function () {
                            this.checked = true;
                        });
                    } else {
                        $(':checkbox').each(function () {
                            this.checked = false;
                        });
                    }
                });


                document.getElementById("deleteUsers").onclick = removeUsers;


                function removeUsers() {
                    const api_url = '/api/removeUsers'
                    let usernameArray = [];
                    if ($("input:checkbox[name=username]:checked").length == 0) {
                        alert("please select some users first.");
                        return;
                    }
                    $("input:checkbox[name=username]:checked").each(function () {
                        usernameArray.push($(this).val());
                    });
                    fetch(api_url.concat(`?users=${usernameArray.join(',')}`)).then(function () {
                        getAllUsers();
                    });

                }

                document.getElementById("promoteToAdmin").onclick = promoteToAdmin;


                function promoteToAdmin() {
                    const api_url = '/api/promoteToAdmin'
                    let usernameArray = [];
                    if ($("input:checkbox[name=username]:checked").length == 0) {
                        alert("please select some users first.");
                        return;
                    }
                    $("input:checkbox[name=username]:checked").each(function () {
                        usernameArray.push($(this).val());
                    });
                    fetch(api_url.concat(`?users=${usernameArray.join(',')}`)).then(function () {
                        getAllUsers();
                    });

                }

                document.getElementById("promoteToModerator").onclick = promoteToModerator;


                function promoteToModerator() {
                    const api_url = '/api/promoteToModerator'
                    let usernameArray = [];
                    if ($("input:checkbox[name=username]:checked").length == 0) {
                        alert("please select some users first.");
                        return;
                    }
                    $("input:checkbox[name=username]:checked").each(function () {
                        usernameArray.push($(this).val());
                    });
                    fetch(api_url.concat(`?users=${usernameArray.join(',')}`)).then(function () {
                        getAllUsers();
                    });

                }
            </script>
</body>

</html>